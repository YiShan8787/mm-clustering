<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<script src="https://static.robotwebtools.org/threejs/current/three.js"></script>
<script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script src="https://static.robotwebtools.org/roslibjs/current/roslib.js"></script>
<script src="../build/ros3d.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

<link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.3.1/css/all.css'><link rel="stylesheet" href="./style.css">

<script>
  /**
   * Setup all visualization elements when the page is loaded.
   */
  var scene;
  var ros_global;
  function init() {
    // Connect to ROS.
    var ros = new ROSLIB.Ros({
      url : 'ws://localhost:9090'
    });
    ros_global = ros;
    // Create the main viewer.
    var viewer = new ROS3D.Viewer({
      divID : 'viewer',
      width : 520,
      height : 705,
      cameraPosition : {x:6,y:8,z:10},
      antialias : true,
      useAxis: false
    });
    scene = viewer;
    viewer.addObject(new ROS3D.Grid());
    // Setup a client to listen to TFs.
    /*
    var tfClient = new ROSLIB.TFClient({
      ros : ros,
      angularThres : 0.01,
      transThres : 0.01,
      rate : 10.0,
      fixedFrame : '/map'
    });

    var cloudClient = new ROS3D.PointCloud2({
        ros: ros,
        tfClient: tfClient,
        rootObject: viewer.scene,
        topic: '/my_pcl_topic',
        material: { size: 0.2, color: 0xeeeeee },
        colorsrc: 'rgb'
    });
    */
  }

  function draw_point(x,y,z,ox,oy,oz,ow,radius,color)
  {
    
    
    var geometry = new THREE.ConeGeometry( 0.1, 0.1, 32 );
    var material = new THREE.MeshBasicMaterial( {color: color} );
    var sphere = new THREE.Mesh( geometry, material );

    //sphere.rotation.z = -Math.PI / 2;
    //sphere.quaternion = new THREE.Quaternion(ox,oy,oz,ow)
    sphere.quaternion.set(ox,oy,oz,ow)
    sphere.position.set(x, y, z)
    
    //sphere.rotation.set(new THREE.Vector3( 0, 0, Math.PI / 2))
    scene.addObject(sphere)
  }

  function select_to_draw() 
  {
    
    var camera = document.forms['camera']
    var x =parseFloat(camera.elements.exampleInputX.value)
    var y =parseFloat(camera.elements.exampleInputY.value)
    var z =parseFloat(camera.elements.exampleInputZ.value)

    var ox =parseFloat(camera.elements.exampleInputoX.value)
    var oy =parseFloat(camera.elements.exampleInputoY.value)
    var oz =parseFloat(camera.elements.exampleInputoZ.value)
    var ow =parseFloat(camera.elements.exampleInputoW.value)
    
    var color = camera.elements.exampleInputcolor.value

    var colorValue = parseInt ( color.replace("#","0x"), 16 )
    var colored = new THREE.Color( colorValue )

    var q = new THREE.Quaternion(ox,oy,oz,ow)
    //draw_point(x,y,z,ox,oy,oz,ow,0.5,colored)
    
    console.log(q)
    /*
    var x = 0.0769366955335
    var y = -0.188204475001
    var z = 0.569669749349
    var ox = -0.651235853023
    var oy = 0.724123518945
    var oz = 0.0915898362405
    var ow = 0.207721676636
    
    
    var q = new THREE.Quaternion(ox,oy,oz,ow)
    var q2 = new THREE.Quaternion()
    q2.setFromAxisAngle(new THREE.Vector3(0,0,1),Math.PI)
    q.multiply( q2 )
    */
    //console.log(q)
    
    draw_point(x,y,z,q.x,q.y,q.z,q.w,0.5,colored)
    

    
    
    /*
    var q1 = q
    q2 = new THREE.Quaternion()
    q2.setFromAxisAngle(new THREE.Vector3(0,0,1),Math.PI/2)
    q1.multiply( q2 )
    console.log("90 degree:")
    console.log(q1)

    var vector = new THREE.Vector3( x, y, z )
    var axis = new THREE.Vector3( 0, 0, 1 )
    var angle = Math.PI/2 
    vector.applyAxisAngle( axis, angle )
    console.log(vector)
    
    draw_point(vector.x,vector.y,vector.z,q1.x,q1.y,q1.z,q1.w,0.5,0x0000ff)
    */
    
  }

  function start_transfer() 
  {
    
    var camera = document.forms['transfer']
    var x =parseFloat(camera.elements.exampletransferX.value)
    var y =parseFloat(camera.elements.exampletransferY.value)
    var z =parseFloat(camera.elements.exampletransferZ.value)

    var ox =parseFloat(camera.elements.exampletransferoX.value)
    var oy =parseFloat(camera.elements.exampletransferoY.value)
    var oz =parseFloat(camera.elements.exampletransferoZ.value)
    var ow =parseFloat(camera.elements.exampletransferoW.value)


    var q = new THREE.Quaternion(ox,oy,oz,ow)
    //draw_point(x,y,z,ox,oy,oz,ow,0.5,colored)
    
    //console.log(q)
    /*
    var x = 0.0769366955335
    var y = -0.188204475001
    var z = 0.569669749349
    var ox = -0.651235853023
    var oy = 0.724123518945
    var oz = 0.0915898362405
    var ow = 0.207721676636
    
    
    var q = new THREE.Quaternion(ox,oy,oz,ow)
    var q2 = new THREE.Quaternion()
    q2.setFromAxisAngle(new THREE.Vector3(0,0,1),Math.PI)
    q.multiply( q2 )
    */
    var q = new THREE.Quaternion(ox,oy,oz,ow)
    var q2 = new THREE.Quaternion()
    q2.setFromAxisAngle(new THREE.Vector3(0,0,1),Math.PI)
    q.multiply( q2 )
    console.log("x:")
    console.log(x)
    console.log("y:")
    console.log(z)
    console.log("z:")
    console.log(y)
    console.log(q)
    
    
    
  }

  function draw_camera_pose() 
  {
    /*
    var tfCamera = new ROSLIB.TFClient({
      ros : ros,
      angularThres : 0.01,
      transThres : 0.01,
      rate : 10.0,
      fixedFrame : '/usb_camera'
    });
    
    var cloudClient = new ROS3D.Pose({
        ros: ros,
        tfClient: tfCamera,
        rootObject: scene.scene,
        topic: '/tag_detections'
        
    });
    */
    //const can = document.createElement("canvas")
    const can = document.getElementById("myCamera")
    var image = new ROSLIB.Topic({
      ros: ros_global,
      //name : '/listener',
      name: '/usb_webcam/image_raw',
      messageType: 'sensor_msgs/Image'
    })

    image.subscribe(function (message) {

      can.width = message.width;
      can.height = message.height;
      const ctx = can.getContext("2d");

      const imgData = ctx.createImageData(message.width, message.height);
      const data = imgData.data;
      const inData = atob(message.data);

      var j = 0; i = 4; // j data in , i data out
      while (j < inData.length) {
        const w1 = inData.charCodeAt(j++);  // read 3 16 bit words represent 1 pixel
        const w2 = inData.charCodeAt(j++);
        const w3 = inData.charCodeAt(j++);
        if (!message.is_bigendian) {
          data[i++] = w1; // red
          data[i++] = w2; // green
          data[i++] = w3; // blue
        } else {
          data[i++] = (w1 >> 8) + ((w1 & 0xFF) << 8);
          data[i++] = (w2 >> 8) + ((w2 & 0xFF) << 8);
          data[i++] = (w3 >> 8) + ((w3 & 0xFF) << 8);
        }
        data[i++] = 255;  // alpha
      }

      ctx.putImageData(imgData, 0, 0);
      
    });


  }

  function add_new_cloud()
  {
    
    var cloud = document.forms['cloud']
    var topic =cloud.elements.exampleTopic.value
    var frame =cloud.elements.exampleFrame.value
    var color =cloud.elements.exampleColor.value

    var colorValue = parseInt ( color.replace("#","0x"), 16 );
    var colored = new THREE.Color( colorValue );
    
    var tfCloud = new ROSLIB.TFClient({
      ros : ros_global,
      angularThres : 0.01,
      transThres : 0.01,
      rate : 10.0,
      fixedFrame : frame
    });

    var cloudClient = new ROS3D.PointCloud2({
        ros: ros_global,
        tfClient: tfCloud,
        rootObject: scene.scene,
        topic: topic,
        material: { size: 0.2, color: colored },
        //colorsrc: 'rgb'
    });
    add_camera()
    /*
    var tfClient = new ROSLIB.TFClient({
      ros : ros_global,
      angularThres : 0.01,
      transThres : 0.01,
      rate : 10.0,
      fixedFrame : '/map'
    });

    var cloudClient = new ROS3D.PointCloud2({
        ros: ros_global,
        tfClient: tfClient,
        rootObject: scene.scene,
        topic: '/my_pcl_topic',
        material: { size: 0.2, color: 0xeeeeee },
        colorsrc: 'rgb'
    });*/
  }
  

</script>

</head>

<body onload="init()">
  
  
    <nav class="navbar navbar-dark bg-dark navbar-expand-sm">
      <a class="navbar-brand" href="#">
        
        RosWebDemo
      </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-list-3" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbar-list-3">
        <ul class="navbar-nav">
            <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              How To Use
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
              <a class="dropdown-item" href="#" data-toggle="modal" data-target="#exampleModal">Action</a>
            </div>
          </li>   
        </ul>
      </div>
    </nav>
  <div class="container-fluid">
    <div class="row">
      <h1>ㅤㅤㅤsimple pcl2 demo
    </div>
    <div class="row">
      <div class="col-md-auto">
        <div id="viewer"></div>
      </div>
      <div class="col-md-auto">
        <!-- camera -->
        
        <div class="row">
          <button class="btn" onclick="add_camera()" data-toggle="popover" data-placement="right" title="Add Point" data-content="put the camera/radar position at the point"><i class="fa fa-anchor" aria-hidden="true"></i></button>
        </div>
        
        <div class="row">
          <button class="btn" onclick="draw_camera_pose()" data-toggle="popover" data-placement="right" title="Camera Correction" data-content="draw the path from the camera correction"><i class="fa fa-camera" aria-hidden="true"></i></button>
        </div>
        
        <div class="row">
          <button class="btn" onclick="add_cloud()" data-toggle="popover" data-placement="right" title="Add Cloud" data-content="Add a cloud from a topic"><i class="fa fa-plus" aria-hidden="true"></i></button>
        </div>

        <div class="row">
          <button class="btn" onclick="input_transfer()" data-toggle="popover" data-placement="right" title="Transfer" data-content="transfer the camera pose from aprilTag to ros 3d world"><i class="fa fa-sort" aria-hidden="true"></i></button>
        </div>
        
      </div>

      <div class="col-md-auto">
        <canvas id="myCamera" width="200" height="100"></canvas>
      </div>
    </div>
    
    
  
  

      <!-- Modal action-->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Run the following commands in the terminal then refresh the page</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <ol>
              <li><tt>roscore</tt></li>
              <li><tt>roslaunch rosbridge_server rosbridge_websocket.launch</tt></li>
              <li><tt>rosrun tf2_web_republisher tf2_web_republisher</tt></li>
            </ol>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            
          </div>
        </div>
      </div>
    </div>

    <!-- Modal camera correction action-->
    <div class="modal fade" id="camactionModal" tabindex="-1" role="dialog" aria-labelledby="camactionModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="camactionModalLabel">Run the following commands in the terminal then refresh the page</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <ol>
              <li><tt>ROS_NAMESPACE=usb_webcam rosrun image_proc image_proc</tt></li>
              <li><tt>roslaunch apriltag_ros continuous_detection.launch</tt></li>
            </ol>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            
          </div>
        </div>
      </div>
    </div>

    <!-- Modal add camera-->
    <div class="modal fade" id="cameraModal" tabindex="-1" role="dialog" aria-labelledby="cameraModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cameraModalLabel">Run the following commands in the terminal then refresh the page</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form name='camera'>
              
              <div class="form-group">
                <label for="exampleInputX">X</label>
                <input type="number" class="form-control" id="exampleInputX" placeholder="0">
              </div>
              <div class="form-group">
                <label for="exampleInputY">Y</label>
                <input type="number" class="form-control" id="exampleInputY" placeholder="0">
              </div>
              <div class="form-group">
                <label for="exampleInputZ">Z</label>
                <input type="number" class="form-control" id="exampleInputZ" placeholder="0">
              </div>
              <div class="form-group">
                <label for="exampleInputoX">orientation X</label>
                <input type="number" class="form-control" id="exampleInputoX" placeholder="0">
              </div>
              <div class="form-group">
                <label for="exampleInputoY">orientation Y</label>
                <input type="number" class="form-control" id="exampleInputoY" placeholder="0">
              </div>
              <div class="form-group">
                <label for="exampleInputoZ">orientation Z</label>
                <input type="number" class="form-control" id="exampleInputoZ" placeholder="0">
              </div>
              <div class="form-group">
                <label for="exampleInputoW">orientation W</label>
                <input type="number" class="form-control" id="exampleInputoW" placeholder="1">
              </div>

              <div class="form-group">
                <label for="exampleInputcolor">color</label>
                <input type="color" id="exampleInputcolor" name="exampleInputcolor"value="#eeeeee">
              </div>

            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" onclick="select_to_draw()" class="btn btn-primary" data-dismiss="modal" >Add</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal add cloud-->
    <div class="modal fade" id="cloudModal" tabindex="-1" role="dialog" aria-labelledby="cloudModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cloudModalLabel">draw the cloud by the topic and it's tf</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form name='cloud'>
              
              <div class="form-group">
                <label for="exampleTopic">topic name</label>
                <input type="text" class="form-control" id="exampleTopic" placeholder="/my_pcl">
              </div>
              <div class="form-group">
                <label for="exampleFrame">fixed frame(tf frame)</label>
                <input type="text" class="form-control" id="exampleFrame" placeholder="/my_map">
              </div>
              <div class="form-group">
                <label for="exampleColor">color</label>
                <input type="color" id="exampleColor" name="exampleColor"value="#eeeeee">
              </div>

            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" onclick="add_new_cloud()" class="btn btn-primary" data-dismiss="modal" >Add</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal transfer-->
    <div class="modal fade" id="transferModal" tabindex="-1" role="dialog" aria-labelledby="transferModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="transferModalLabel">Run the following commands in the terminal then refresh the page</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form name='transfer'>
              
              <div class="form-group">
                <label for="exampletransferX">X</label>
                <input type="number" class="form-control" id="exampletransferX" placeholder="0">
              </div>
              <div class="form-group">
                <label for="exampletransferY">Y</label>
                <input type="number" class="form-control" id="exampletransferY" placeholder="0">
              </div>
              <div class="form-group">
                <label for="exampletransferZ">Z</label>
                <input type="number" class="form-control" id="exampletransferZ" placeholder="0">
              </div>
              <div class="form-group">
                <label for="exampletransferoX">orientation X</label>
                <input type="number" class="form-control" id="exampletransferoX" placeholder="0">
              </div>
              <div class="form-group">
                <label for="exampletransferoY">orientation Y</label>
                <input type="number" class="form-control" id="exampletransferoY" placeholder="0">
              </div>
              <div class="form-group">
                <label for="exampletransferoZ">orientation Z</label>
                <input type="number" class="form-control" id="exampletransferoZ" placeholder="0">
              </div>
              <div class="form-group">
                <label for="exampletransferoW">orientation W</label>
                <input type="number" class="form-control" id="exampletransferoW" placeholder="1">
              </div>

            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" onclick="start_transfer()" class="btn btn-primary" data-dismiss="modal" >start</button>
          </div>
        </div>
      </div>
    </div>
  
  </div>
  </ul> 
   <!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
   <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

   <script>
    $(document).ready(function(){
      $('[data-toggle="popover"]').popover({ trigger: "hover" });   
      
      

    });

    function add_camera(){
        clear_input_camera()
        $('#cameraModal').modal('show')
    }
    function add_cloud(){
        clear_input_cloud()
        $('#cloudModal').modal('show')
    }
    function input_transfer(){
        //clear_input_transfer()
        $('#transferModal').modal('show')
    }
    function clear_input_camera(){
      $('#cameraModal').find('form')[0].reset();
    }
    function clear_input_cloud(){
      $('#cloudModal').find('form')[0].reset();
    }
    function clear_input_transfer(){
      $('#transferModal').find('form')[0].reset();
    }
    
    </script>
   
</body>
</html>
